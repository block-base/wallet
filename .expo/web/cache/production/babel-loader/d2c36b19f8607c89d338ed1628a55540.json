{"ast":null,"code":"var BN=require('bn.js');var MillerRabin=require('miller-rabin');var millerRabin=new MillerRabin();var TWENTYFOUR=new BN(24);var ELEVEN=new BN(11);var TEN=new BN(10);var THREE=new BN(3);var SEVEN=new BN(7);var primes=require(\"./generatePrime\");var randomBytes=require('randombytes');module.exports=DH;function setPublicKey(pub,enc){enc=enc||'utf8';if(!Buffer.isBuffer(pub)){pub=new Buffer(pub,enc);}this._pub=new BN(pub);return this;}function setPrivateKey(priv,enc){enc=enc||'utf8';if(!Buffer.isBuffer(priv)){priv=new Buffer(priv,enc);}this._priv=new BN(priv);return this;}var primeCache={};function checkPrime(prime,generator){var gen=generator.toString('hex');var hex=[gen,prime.toString(16)].join('_');if(hex in primeCache){return primeCache[hex];}var error=0;if(prime.isEven()||!primes.simpleSieve||!primes.fermatTest(prime)||!millerRabin.test(prime)){error+=1;if(gen==='02'||gen==='05'){error+=8;}else{error+=4;}primeCache[hex]=error;return error;}if(!millerRabin.test(prime.shrn(1))){error+=2;}var rem;switch(gen){case'02':if(prime.mod(TWENTYFOUR).cmp(ELEVEN)){error+=8;}break;case'05':rem=prime.mod(TEN);if(rem.cmp(THREE)&&rem.cmp(SEVEN)){error+=8;}break;default:error+=4;}primeCache[hex]=error;return error;}function DH(prime,generator,malleable){this.setGenerator(generator);this.__prime=new BN(prime);this._prime=BN.mont(this.__prime);this._primeLen=prime.length;this._pub=undefined;this._priv=undefined;this._primeCode=undefined;if(malleable){this.setPublicKey=setPublicKey;this.setPrivateKey=setPrivateKey;}else{this._primeCode=8;}}Object.defineProperty(DH.prototype,'verifyError',{enumerable:true,get:function get(){if(typeof this._primeCode!=='number'){this._primeCode=checkPrime(this.__prime,this.__gen);}return this._primeCode;}});DH.prototype.generateKeys=function(){if(!this._priv){this._priv=new BN(randomBytes(this._primeLen));}this._pub=this._gen.toRed(this._prime).redPow(this._priv).fromRed();return this.getPublicKey();};DH.prototype.computeSecret=function(other){other=new BN(other);other=other.toRed(this._prime);var secret=other.redPow(this._priv).fromRed();var out=new Buffer(secret.toArray());var prime=this.getPrime();if(out.length<prime.length){var front=new Buffer(prime.length-out.length);front.fill(0);out=Buffer.concat([front,out]);}return out;};DH.prototype.getPublicKey=function getPublicKey(enc){return formatReturnValue(this._pub,enc);};DH.prototype.getPrivateKey=function getPrivateKey(enc){return formatReturnValue(this._priv,enc);};DH.prototype.getPrime=function(enc){return formatReturnValue(this.__prime,enc);};DH.prototype.getGenerator=function(enc){return formatReturnValue(this._gen,enc);};DH.prototype.setGenerator=function(gen,enc){enc=enc||'utf8';if(!Buffer.isBuffer(gen)){gen=new Buffer(gen,enc);}this.__gen=gen;this._gen=new BN(gen);return this;};function formatReturnValue(bn,enc){var buf=new Buffer(bn.toArray());if(!enc){return buf;}else{return buf.toString(enc);}}","map":{"version":3,"sources":["/Users/naohirofujie/.anyenv/envs/nodenv/versions/14.5.0/lib/node_modules/expo-cli/node_modules/diffie-hellman/lib/dh.js"],"names":["BN","require","MillerRabin","millerRabin","TWENTYFOUR","ELEVEN","TEN","THREE","SEVEN","primes","randomBytes","module","exports","DH","setPublicKey","pub","enc","Buffer","isBuffer","_pub","setPrivateKey","priv","_priv","primeCache","checkPrime","prime","generator","gen","toString","hex","join","error","isEven","simpleSieve","fermatTest","test","shrn","rem","mod","cmp","malleable","setGenerator","__prime","_prime","mont","_primeLen","length","undefined","_primeCode","Object","defineProperty","prototype","enumerable","get","__gen","generateKeys","_gen","toRed","redPow","fromRed","getPublicKey","computeSecret","other","secret","out","toArray","getPrime","front","fill","concat","formatReturnValue","getPrivateKey","getGenerator","bn","buf"],"mappings":"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","sourcesContent":["var BN = require('bn.js');\nvar MillerRabin = require('miller-rabin');\nvar millerRabin = new MillerRabin();\nvar TWENTYFOUR = new BN(24);\nvar ELEVEN = new BN(11);\nvar TEN = new BN(10);\nvar THREE = new BN(3);\nvar SEVEN = new BN(7);\nvar primes = require('./generatePrime');\nvar randomBytes = require('randombytes');\nmodule.exports = DH;\n\nfunction setPublicKey(pub, enc) {\n  enc = enc || 'utf8';\n  if (!Buffer.isBuffer(pub)) {\n    pub = new Buffer(pub, enc);\n  }\n  this._pub = new BN(pub);\n  return this;\n}\n\nfunction setPrivateKey(priv, enc) {\n  enc = enc || 'utf8';\n  if (!Buffer.isBuffer(priv)) {\n    priv = new Buffer(priv, enc);\n  }\n  this._priv = new BN(priv);\n  return this;\n}\n\nvar primeCache = {};\nfunction checkPrime(prime, generator) {\n  var gen = generator.toString('hex');\n  var hex = [gen, prime.toString(16)].join('_');\n  if (hex in primeCache) {\n    return primeCache[hex];\n  }\n  var error = 0;\n\n  if (prime.isEven() ||\n    !primes.simpleSieve ||\n    !primes.fermatTest(prime) ||\n    !millerRabin.test(prime)) {\n    //not a prime so +1\n    error += 1;\n\n    if (gen === '02' || gen === '05') {\n      // we'd be able to check the generator\n      // it would fail so +8\n      error += 8;\n    } else {\n      //we wouldn't be able to test the generator\n      // so +4\n      error += 4;\n    }\n    primeCache[hex] = error;\n    return error;\n  }\n  if (!millerRabin.test(prime.shrn(1))) {\n    //not a safe prime\n    error += 2;\n  }\n  var rem;\n  switch (gen) {\n    case '02':\n      if (prime.mod(TWENTYFOUR).cmp(ELEVEN)) {\n        // unsuidable generator\n        error += 8;\n      }\n      break;\n    case '05':\n      rem = prime.mod(TEN);\n      if (rem.cmp(THREE) && rem.cmp(SEVEN)) {\n        // prime mod 10 needs to equal 3 or 7\n        error += 8;\n      }\n      break;\n    default:\n      error += 4;\n  }\n  primeCache[hex] = error;\n  return error;\n}\n\nfunction DH(prime, generator, malleable) {\n  this.setGenerator(generator);\n  this.__prime = new BN(prime);\n  this._prime = BN.mont(this.__prime);\n  this._primeLen = prime.length;\n  this._pub = undefined;\n  this._priv = undefined;\n  this._primeCode = undefined;\n  if (malleable) {\n    this.setPublicKey = setPublicKey;\n    this.setPrivateKey = setPrivateKey;\n  } else {\n    this._primeCode = 8;\n  }\n}\nObject.defineProperty(DH.prototype, 'verifyError', {\n  enumerable: true,\n  get: function () {\n    if (typeof this._primeCode !== 'number') {\n      this._primeCode = checkPrime(this.__prime, this.__gen);\n    }\n    return this._primeCode;\n  }\n});\nDH.prototype.generateKeys = function () {\n  if (!this._priv) {\n    this._priv = new BN(randomBytes(this._primeLen));\n  }\n  this._pub = this._gen.toRed(this._prime).redPow(this._priv).fromRed();\n  return this.getPublicKey();\n};\n\nDH.prototype.computeSecret = function (other) {\n  other = new BN(other);\n  other = other.toRed(this._prime);\n  var secret = other.redPow(this._priv).fromRed();\n  var out = new Buffer(secret.toArray());\n  var prime = this.getPrime();\n  if (out.length < prime.length) {\n    var front = new Buffer(prime.length - out.length);\n    front.fill(0);\n    out = Buffer.concat([front, out]);\n  }\n  return out;\n};\n\nDH.prototype.getPublicKey = function getPublicKey(enc) {\n  return formatReturnValue(this._pub, enc);\n};\n\nDH.prototype.getPrivateKey = function getPrivateKey(enc) {\n  return formatReturnValue(this._priv, enc);\n};\n\nDH.prototype.getPrime = function (enc) {\n  return formatReturnValue(this.__prime, enc);\n};\n\nDH.prototype.getGenerator = function (enc) {\n  return formatReturnValue(this._gen, enc);\n};\n\nDH.prototype.setGenerator = function (gen, enc) {\n  enc = enc || 'utf8';\n  if (!Buffer.isBuffer(gen)) {\n    gen = new Buffer(gen, enc);\n  }\n  this.__gen = gen;\n  this._gen = new BN(gen);\n  return this;\n};\n\nfunction formatReturnValue(bn, enc) {\n  var buf = new Buffer(bn.toArray());\n  if (!enc) {\n    return buf;\n  } else {\n    return buf.toString(enc);\n  }\n}\n"]},"metadata":{},"sourceType":"script"}